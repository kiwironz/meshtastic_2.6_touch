; ===========================================
; EEL ESP32-S3 Touch Board Configuration for Meshtastic 2.6.11
; ===========================================

[env:eel_esp32s3_touch]
; extends = arduino_base, esp32_base, radiolib_base, device-ui_base
extends = esp32s3_base, device-ui_base
board = eel_esp32s3_touch

board_build.partitions = default_16MB.csv
board_build.psram_type = opi
board_build.arduino.memory_type = qio_opi
board_build.flash_mode = qio
board_upload.flash_size = 16MB

build_unflags =
    -flto

upload_protocol = esptool
upload_speed = 921600
monitor_speed = 115200
upload_port = /dev/ttyACM0
upload_flags =
    --before
    no_reset

build_flags =
    ${esp32_base.build_flags}
    -I variants/eel_esp32s3_touch
    -mfix-esp32-psram-cache-issue
    -I .pio/libdeps/eel_esp32s3_touch/lvgl
    -I .pio/libdeps/eel_esp32s3_touch/meshtastic-device-ui/generated/ui_320x240/



    ; Board identification
    -D HW_VENDOR=meshtastic_HardwareModel_PRIVATE_HW
    -D EEL_ESP32S3_TOUCH

    ; LVGL configuration
    -D LV_LVGL_H_INCLUDE_SIMPLE
    -D LV_CONF_INCLUDE_SIMPLE
    -D LV_COMP_CONF_INCLUDE_SIMPLE
    -D LV_USE_SYSMON=0
    -D LV_USE_PROFILER=0
    -D LV_USE_PERF_MONITOR=0
    -D LV_USE_MEM_MONITOR=0
    -D LV_BUILD_TEST=0
    -D VIEW_320x240
    -D CONFIG_DISABLE_HAL_LOCKS=1
    -D MAP_FULL_REDRAW                ; Force full screen redraw (like t-deck)

    -D HAS_WIFI=0                     ; WiFi disabled (excluded below)
    -D HAS_BLUETOOTH=0                ; Bluetooth disabled (excluded below)
    -D HAS_RADIO=1                    ; Enable LoRa radio

    ; Display configuration - ST7789 320x240 with LovyanGFX
    ; TFT uses device-ui (LVGL), not legacy OLED screen system
    -D HAS_SCREEN=0                   ; Legacy OLED screen disabled (TFT uses device-ui instead)
    -D HAS_TFT=1                      ; Enable TFT display
    -D HAS_TOUCHSCREEN=0              ; Touch disabled for now
    -D USE_PACKET_API                 ; Enable PacketAPI for TFT/LVGL UI

    ; LGFX generic driver configuration
    -D LGFX_DRIVER_TEMPLATE
    -D LGFX_DRIVER=LGFX_GENERIC
    -D GFX_DRIVER_INC=\"graphics/LGFX/LGFX_GENERIC.h\"
    -D LGFX_PANEL=ST7789
    -D LGFX_CFG_HOST=SPI3_HOST
    -D LGFX_PIN_SCK=2
    -D LGFX_PIN_MOSI=3
    -D LGFX_PIN_MISO=4
    -D LGFX_PIN_DC=1
    -D LGFX_PIN_CS=16
    -D LGFX_PIN_RST=12
    -D LGFX_PIN_BL=15
    -D LGFX_INVERT_LIGHT=false
    -D LGFX_PWM_FREQ=44100
    -D LGFX_PWM_CHANNEL=7
    -D LGFX_SCREEN_WIDTH=240
    -D LGFX_SCREEN_HEIGHT=320
    -D LGFX_ROTATION=3
    -D LGFX_INVERT_COLOR=false
    -D SPI_FREQUENCY=60000000
    ; Backlight and advanced parameters (not supported by LGFX_GENERIC)
    ; If backlight control needed, implement custom LGFX driver (see LGFX_EEL_ESP32S3.h)
    ; -D TFT_BACKLIGHT_ON=HIGH          ; Backlight polarity (for legacy TFT only)
    ; -D SPI_READ_FREQUENCY=16000000    ; SPI read speed (not used by LGFX_GENERIC)
    ; -D LGFX_BL_PWM_CHANNEL=7          ; PWM channel for dimming
    ; -D LGFX_BL_PWM_FREQ=44100         ; PWM frequency for dimming
    ; -------------------------------------------
    ; Radio
    -D USE_SX1262
    -D SX126X_DIO3_TCXO_VOLTAGE=1.8

    ; Exclusions
    -D MESHTASTIC_EXCLUDE_WIFI=1
    -D MESHTASTIC_EXCLUDE_WEBSERVER=1
    -D MESHTASTIC_EXCLUDE_MQTT=1
    ; I2C is not physically present on this board - handled by variant.h (HAS_I2C=0, pins=-1)
    ; Do not exclude at build time to avoid accelerometerThread compilation issues
    ; -D MESHTASTIC_EXCLUDE_I2C=1
    -D MESHTASTIC_EXCLUDE_ENVIRONMENTAL_SENSOR=1
    -D MESHTASTIC_EXCLUDE_POWER_TELEMETRY=1
    -D MESHTASTIC_EXCLUDE_DEVICE_METRICS=1
    -D MESHTASTIC_EXCLUDE_INPUTBROKER=1
    -D MESHTASTIC_EXCLUDE_AUDIO=1
    -D MESHTASTIC_EXCLUDE_REMOTE_HARDWARE=1
    -D MESHTASTIC_EXCLUDE_EXTERNALNOTIFICATION=1
    -D MESHTASTIC_EXCLUDE_POWER_FSM=1
    -D EXCLUDE_POWER_FSM=1          ; PowerFSM.cpp checks for this (without MESHTASTIC_ prefix)
    -D MESHTASTIC_EXCLUDE_GPS=1
    -D MESHTASTIC_EXCLUDE_DISPLAY_DEBUG=1
    -D MESHTASTIC_EXCLUDE_RTTTL=1
    -D MESHTASTIC_EXCLUDE_SDCARD=1
    ; -D NO_USB_SERIAL=1              ; COMMENTED OUT - We need serial for debug output!
    -D MESHTASTIC_EXCLUDE_BLUETOOTH=1
    ; -D MESHTASTIC_EXCLUDE_I2C_SCAN=1
        ; I2C pins are marked as unavailable in the variant header (I2C_SDA/I2C_SCL = -1)
        ; Do not globally exclude I2C here because some headers use __has_include() and
        ; expect sensor classes to be defined when supporting libraries are present.

    ; Other
    -D NEOPIXEL_DATA=13
    -D BUTTON_PIN=18
    -D RAM_SIZE=5120
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D BOARD_HAS_PSRAM                ; ESP32-S3 has PSRAM



; lib_ignore =
;     Wire
;     SPI

lib_deps =
    ${esp32_base.lib_deps}
    ${device-ui_base.lib_deps}
    lovyan03/LovyanGFX@^1.1.16


build_src_filter =
    ${esp32s3_base.build_src_filter}